---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="AI Search Engine" sideBarActiveItemID="Tanya AI">
  <div class="flex flex-col items-center min-h-screen py-16 bg-gradient-to-b from-blue-50 via-white to-blue-50">
    
    <!-- Header -->
    <h1 class="text-5xl font-extrabold text-blue-700 mb-8">ğŸ”® AI Search Engine</h1>
    <p class="text-gray-600 text-lg mb-12 text-center max-w-2xl">
      Tanyakan apapun, dan AI akan memberikan jawaban akurat beserta sumber terpercaya.
    </p>

    <!-- Form Card -->
    <form id="searchForm" class="w-full max-w-3xl bg-white rounded-3xl shadow-2xl p-8 space-y-6">
      <div>
        <label class="block font-semibold text-gray-700 mb-2">Pertanyaan Anda:</label>
        <textarea
          id="query"
          name="query"
          rows="4"
          placeholder="Contoh: Apa itu quantum computing?"
          required
          class="w-full p-4 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-700 text-lg resize-none transition"
        ></textarea>
      </div>

      <div class="text-center">
        <button
          type="submit"
          class="inline-flex items-center gap-2 px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-2xl shadow-lg hover:shadow-xl transition"
        >
          ğŸ” Cari Jawaban
        </button>
      </div>
    </form>

    <!-- Result Section -->
    <div id="result" class="mt-10 w-full max-w-3xl space-y-4"></div>
  </div>

  <script>
  const form = document.getElementById("searchForm");
  const resultDiv = document.getElementById("result");
  const submitButton = form.querySelector('button[type="submit"]');

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);

    // 1. Disable button dan ubah teks/icon
    submitButton.disabled = true;
    const originalText = submitButton.innerHTML;
    submitButton.innerHTML = 'â³ Sedang mencari...';

    // Tampilkan loading di result
    resultDiv.innerHTML = `
      <div class="p-6 bg-white rounded-2xl shadow-md flex items-center gap-3 animate-pulse text-gray-500">
        â³ AI sedang merangkum jawaban...
      </div>
    `;

    try {
      const res = await fetch("/api/search", { method: "POST", body: formData });
      const data = await res.json();

      if (!res.ok) {
        resultDiv.innerHTML = `
          <div class="p-6 bg-red-100 text-red-600 rounded-2xl shadow">
            âŒ Error: ${data.error || "Gagal mendapatkan hasil."}
          </div>
        `;
        return;
      }

      // Display results
      let html = `
        <div class="p-6 bg-white rounded-2xl shadow hover:shadow-lg transition">
          <p class="text-gray-800 whitespace-pre-wrap">${data.result}</p>
        </div>
      `;

      if (data.sources && data.sources.length > 0) {
        html += `
          <div class="p-6 bg-white rounded-2xl shadow space-y-2">
            <h4 class="text-gray-600 font-semibold mb-2">ğŸ“š Sumber Referensi:</h4>
            <ul class="list-disc ml-5 text-blue-600 space-y-1">
              ${data.sources.map(src => `<li><a href="${src.uri}" target="_blank" class="hover:underline">${src.title || src.uri}</a></li>`).join('')}
            </ul>
          </div>
        `;
      }

      resultDiv.innerHTML = html;
    } catch (err) {
      console.error(err);
      resultDiv.innerHTML = `
        <div class="p-6 bg-red-100 text-red-600 rounded-2xl shadow">
          âŒ Terjadi kesalahan. Coba lagi.
        </div>
      `;
    } finally {
      // 2. Enable button kembali dan restore teks asli
      submitButton.disabled = false;
      submitButton.innerHTML = originalText;
    }
  });
</script>
</BaseLayout>
